(function(App) {

	App.Views.Mosu = React.createClass({
		loadJobAppDataFromServer: function() {
			this.setState({loading: true});
			$.ajax({
				url: this.props.url,
				dataType: 'json',
				cache: false,
				success: function(data) {
					if (typeof data.error !== 'undefined') {
						this.setState({error: data.error});
					} else {
						this.setState({ data: data, ajaxError: null});
					}
				}.bind(this),
				error: function(xhr, status, err) {
					this.setState({ajaxError: err.toString()});
					console.error(this.props.url, status, err.toString());
				}.bind(this),
				complete: function() {
					this.setState({loading: false});
				}.bind(this)
			});
		},
		handleNewApplicationSubmit: function(jobApplication) {
		    var job_applications = this.state.data;
		    // Optimistically set an id on the new comment. It will be replaced by an
		    // id generated by the server. In a production application you would likely
		    // not use Date.now() for this and would have a more robust system in place.
		    jobApplication.id = Date.now();
		    var new_job_applications = job_applications.concat([jobApplication]);
		    this.setState({data: new_job_applications });
	        $.ajax({
		      url: this.props.url,
		      dataType: 'json',
		      type: 'POST',
		      data: jobApplication,
		      success: function(data) {
		        this.setState({ data: data});
		      }.bind(this),
		      error: function(xhr, status, err) {
		        console.error(this.props.url, status, err.toString());
		      }.bind(this)
		    });
		},
		handleModifyApplicationSubmit: function(jobApplication, id) {
	        $.ajax({
		      url: this.props.url + '/update/' + id,
		      dataType: 'json',
		      type: 'POST',
		      data: jobApplication,
		      success: function(data) {
		        this.setState({ data: data});
		      }.bind(this),
		      error: function(xhr, status, err) {
		        console.error(this.props.url, status, err.toString());
		      }.bind(this)
		    });
		},
		getInitialState: function() {
			return {
				loading: false,
				error: null,
				ajaxError: null,
				data: []
			};
		},
		// When component is loaded successfully
		componentDidMount: function() {
			this.loadJobAppDataFromServer();
		},
		componentDidUpdate: function(){
			// var updated_job_list = this.state.data;
			// this.setState({ data: updated_job_list })
		},
		render: function() {
			return (
				<div className="mosu-container container">
					<App.Views.InspirationBox />

					<App.Views.ApplicationList 
						data={ this.state.data } 
						callbackAppSubmit={ this.handleModifyApplicationSubmit }
					/>
		            <App.Views.NewApplicationForm 
		                data={this.state.data} 
		                onNewAppSubmit={this.handleNewApplicationSubmit}
		                />
				</div>
			);
		}
	});
})(App);